<!DOCTYPE html>
<html>
  <head>
    <title>マイクのデシベル値を測定する</title>
  </head>
  <body>
    <div>
      <h1>マイクのデシベル値を測定する</h1>
      <p>マイクから音声を取得してデシベル値を測定します。</p>
      <p id="db"></p>
      <button onclick="startRecording()">録音開始</button>
      <button onclick="stopRecording()">録音停止</button>
    </div>

    <script>
      // Web Audio APIを使用するためのコンテキストを作成する
      const audioContext = new AudioContext();

      // マイクからの音声を取得するためのメディアストリームを取得する
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then((stream) => {
          // ストリームからAudioNodeを作成する
          const sourceNode = audioContext.createMediaStreamSource(stream);

          // デシベル値を測定するためのAnalyzerNodeを作成する
          const analyserNode = audioContext.createAnalyser();
          analyserNode.fftSize = 2048;

          // AudioNodeを接続する
          sourceNode.connect(analyserNode);

          // デシベル値を測定するための関数
          function getDecibelValue() {
            const bufferLength = analyserNode.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            analyserNode.getFloatFrequencyData(dataArray);
            const total = dataArray.reduce((acc, val) => acc + val * val, 0);
            const rms = Math.sqrt(total / bufferLength);
            const db = 20 * Math.log10(rms);
            return db.toFixed(2);
          }

          let intervalId;

          // 録音を開始する関数
          function startRecording() {
            intervalId = setInterval(() => {
              const db = getDecibelValue();
              document.getElementById('db').innerHTML = `${db} dB`;
            }, 100);
          }

          // 録音を停止する関数
          function stopRecording() {
            clearInterval(intervalId);
            document.getElementById('db').innerHTML = '';
          }
        })
        .catch((err) => {
          console.error(err);
        });
    </script>
  </body>
</html>
